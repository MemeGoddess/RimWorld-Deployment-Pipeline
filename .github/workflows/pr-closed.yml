name: Build and Commit to Main on PR Close
description: Builds the mod when a pull request is merged, and commits any build artifacts (DLLs) back to the main branch.

on:
    workflow_call:
        inputs:
            ExcludedProjectFiles:
                required: false
                default: ''
                description: 'Comma-separated list of project files to exclude from build, e.g. "Source/Mod1.csproj, Source/Mod2.csproj"'
                type: string

jobs:
    pr-closed-build:
        name: Build on PR Close
        if: ${{ github.event.pull_request.merged == true }}
        runs-on: ubuntu-latest

        steps:
          - name: Checkout repository
            uses: actions/checkout@v4
            with:
                fetch-depth: 0
                path: 'mod'

          - name: Detect project files
            id: detect_projects
            working-directory: 'mod'
            run: |
              set -euo pipefail
              # Auto-detect .csproj files
              DETECTED_PROJECTS=$(find . -type f -name '*.csproj' -printf '%P\n' | grep -v '[{}]' | grep -v '^Workshop/' | paste -sd, - || echo "")
              # Exclude any specified project files
              EXCLUDED="${{ inputs.ExcludedProjectFiles }}"
              IFS=',' read -ra EXCL_ARR <<< "$EXCLUDED"
              for EXCL in "${EXCL_ARR[@]}"; do
                EXCL="$(printf '%s' "$EXCL" | xargs)"  # trim whitespace
                if [ -n "$EXCL" ]; then
                  DETECTED_PROJECTS=$(printf '%s' "$DETECTED_PROJECTS" | tr ',' '\n' | grep -v -F "$EXCL" | paste -sd, - || echo "")
                fi
              done
              echo "PROJECT_FILES=$DETECTED_PROJECTS" >> $GITHUB_ENV
              echo "PROJECT_FILES=$DETECTED_PROJECTS" >> $GITHUB_OUTPUT
              echo "Detected project files: $DETECTED_PROJECTS"
            
          - name: Set up .NET SDK
            if: ${{ steps.detect_projects.outputs.PROJECT_FILES != '' }}
            uses: actions/setup-dotnet@v4
            with:
              dotnet-version: '8.0.x'

          - name: Download Steam Workshop Dependencies
            if: ${{ steps.detect_projects.outputs.PROJECT_FILES != '' }}
            uses: MemeGoddess/RimWorld-Deployment-Pipeline/.github/actions/download-steam-workshop@latest
            with: 
              path: 'mod'

          - name: Build Mod
            if: ${{ steps.detect_projects.outputs.PROJECT_FILES != '' }}
            working-directory: mod
            run: |
                set -euo pipefail
                FILES="${{ steps.detect_projects.outputs.PROJECT_FILES }}"
                IFS=',' read -ra FILE_ARR <<< "$FILES"
                for FILE in "${FILE_ARR[@]}"; do
                    FILE="$(printf '%s' "$FILE" | xargs)"  # trim whitespace
                    if [ -n "$FILE" ]; then
                    echo "Building: $FILE"
                    dotnet build "$FILE" --configuration Debug
                    fi
                done

          - name: Commit build artifacts
            if: ${{ steps.detect_projects.outputs.PROJECT_FILES != '' }}
            working-directory: mod
            run: |
                if [ -z "$(git ls-files -m -- '*.dll')" ]; then
                    exit 0
                fi

                git config --global user.name "github-actions[bot]"
                git config --global user.email "github-actions[bot]@users.noreply.github.com"
                
                git ls-files -m -- '*.dll' | xargs -r git add -- || true
                COMMIT_MSG="chore: Build mod after PR #${{ github.event.pull_request.number }} merged"
                git commit -m "$COMMIT_MSG" || echo "No changes to commit"
                git push origin HEAD:${{ github.event.pull_request.base.ref }}